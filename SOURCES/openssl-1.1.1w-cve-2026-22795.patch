From de6b2b2df0190479f180b8350ec355abbffdf643 Mon Sep 17 00:00:00 2001
From: Dmitriy Popov <dpopov@cloudlinux.com>
Date: Thu, 29 Jan 2026 04:17:41 +0200
Subject: [PATCH 7/7] openssl-1.1.1w-cve-2026-22795

Partially backport the following upstream commit:

    From c08264903396074ba9e5f9d5a40843cd521636d7 Mon Sep 17 00:00:00 2001
    From: Bob Beck <beck@openssl.org>
    Date: Wed Jan 7 11:29:48 2026 -0700
    Subject: [PATCH] Ensure ASN1 types are checked before use.

    Some of these were fixed by LibreSSL in commit
    https://github.com/openbsd/src/commit/aa1f637d454961d22117b4353f98253e984b3ba8
    this fix includes the other fixes in that commit, as well as fixes for
    others found by a scan for a similar unvalidated access paradigm in
    the tree.

    In crypto/pkcs12/p12_kiss.c, the code did not verify that the ASN1_TYPE
    returned by PKCS12_SAFEBAG_get0_attr() is actually a BMPSTRING or
    OCTET_STRING before accessing it as such.

    In apps/s_client.c, the code did not verify that the ASN1_TYPE returned
    by ASN1_generate_nconf() is actually a SEQUENCE before accessing it as
    such.

    CVE-2026-22795

    Reviewed-by: Kurt Roeckx <kurt@roeckx.be>
    Reviewed-by: Shane Lontis <shane.lontis@oracle.com>
    Reviewed-by: Tomas Mraz <tomas@openssl.org>
    (Merged from https://github.com/openssl/openssl/pull/29582)

Note: This is a partial backport. The full upstream commit also includes
a fix for CVE-2026-22796 (crypto/pkcs7/pk7_doit.c).

Signed-off-by: Dmitriy Popov <dpopov@cloudlinux.com>
---
 apps/s_client.c          |  3 ++-
 crypto/pkcs12/p12_kiss.c | 10 ++++++++--
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/apps/s_client.c b/apps/s_client.c
index 00effc8..39df178 100644
--- a/apps/s_client.c
+++ b/apps/s_client.c
@@ -2698,8 +2698,9 @@ int s_client_main(int argc, char **argv)
                 goto end;
             }
             atyp = ASN1_generate_nconf(genstr, cnf);
-            if (atyp == NULL) {
+            if (atyp == NULL || atyp->type != V_ASN1_SEQUENCE) {
                 NCONF_free(cnf);
+                ASN1_TYPE_free(atyp);
                 BIO_printf(bio_err, "ASN1_generate_nconf failed\n");
                 goto end;
             }
diff --git a/crypto/pkcs12/p12_kiss.c b/crypto/pkcs12/p12_kiss.c
index 7ab9838..d90404d 100644
--- a/crypto/pkcs12/p12_kiss.c
+++ b/crypto/pkcs12/p12_kiss.c
@@ -183,11 +183,17 @@ static int parse_bag(PKCS12_SAFEBAG *bag, const char *pass, int passlen,
     ASN1_BMPSTRING *fname = NULL;
     ASN1_OCTET_STRING *lkid = NULL;
 
-    if ((attrib = PKCS12_SAFEBAG_get0_attr(bag, NID_friendlyName)))
+    if ((attrib = PKCS12_SAFEBAG_get0_attr(bag, NID_friendlyName))) {
+        if (attrib->type != V_ASN1_BMPSTRING)
+            return 0;
         fname = attrib->value.bmpstring;
+    }
 
-    if ((attrib = PKCS12_SAFEBAG_get0_attr(bag, NID_localKeyID)))
+    if ((attrib = PKCS12_SAFEBAG_get0_attr(bag, NID_localKeyID))) {
+        if (attrib->type != V_ASN1_OCTET_STRING)
+            return 0;
         lkid = attrib->value.octet_string;
+    }
 
     switch (PKCS12_SAFEBAG_get_nid(bag)) {
     case NID_keyBag:
-- 
2.34.1

