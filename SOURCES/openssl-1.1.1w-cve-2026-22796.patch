From eeb3af64a541afe14e1193a7816c2a98837e1515 Mon Sep 17 00:00:00 2001
From: Dmitriy Popov <dpopov@cloudlinux.com>
Date: Thu, 29 Jan 2026 04:14:00 +0200
Subject: [PATCH 1/7] openssl-1.1.1w-cve-2026-22796

Partially backport the following upstream commit:

    From c08264903396074ba9e5f9d5a40843cd521636d7 Mon Sep 17 00:00:00 2001
    From: Bob Beck <beck@openssl.org>
    Date: Wed Jan 7 11:29:48 2026 -0700
    Subject: [PATCH] Ensure ASN1 types are checked before use.

    In PKCS7_digest_from_attributes(), the code did not verify that
    the ASN1_TYPE returned by get_attribute() is actually an
    OCTET_STRING before accessing it as such. This could lead to
    type confusion if a malformed PKCS7 structure is processed.

    CVE-2026-22796

    Reviewed-by: Kurt Roeckx <kurt@roeckx.be>
    Reviewed-by: Shane Lontis <shane.lontis@oracle.com>
    Reviewed-by: Tomas Mraz <tomas@openssl.org>
    (Merged from https://github.com/openssl/openssl/pull/29582)

Note: This is a partial backport. The full upstream commit also includes
fixes for CVE-2026-22795 (apps/s_client.c and crypto/pkcs12/p12_kiss.c).

Signed-off-by: Dmitriy Popov <dpopov@cloudlinux.com>
---
 crypto/pkcs7/pk7_doit.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/crypto/pkcs7/pk7_doit.c b/crypto/pkcs7/pk7_doit.c
index f63fbc5..4e0eb1e 100644
--- a/crypto/pkcs7/pk7_doit.c
+++ b/crypto/pkcs7/pk7_doit.c
@@ -1092,6 +1092,8 @@ ASN1_OCTET_STRING *PKCS7_digest_from_attributes(STACK_OF(X509_ATTRIBUTE) *sk)
     ASN1_TYPE *astype;
     if ((astype = get_attribute(sk, NID_pkcs9_messageDigest)) == NULL)
         return NULL;
+    if (astype->type != V_ASN1_OCTET_STRING)
+        return NULL;
     return astype->value.octet_string;
 }
 
-- 
2.34.1

