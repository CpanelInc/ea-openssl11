From 1a8fac9693a5663da4aa8158ebb67ed83e390f98 Mon Sep 17 00:00:00 2001
From: Dmitriy Popov <dpopov@cloudlinux.com>
Date: Mon, 18 Mar 2024 20:12:02 +0200
Subject: [PATCH] openssl-1.1.1w-cve-2024-0727-tests

Backport the following upstream commit:

    From febb086d0fc1ea12181f4d833aa9b8fdf2133b3b Mon Sep 17 00:00:00 2001
    From: Matt Caswell <matt@openssl.org>
    Date: Fri, 19 Jan 2024 14:32:18 +0000
    Subject: [PATCH] Add some tests for various PKCS12 files with NULL ContentInfo

    PKCS7 ContentInfo fields held within a PKCS12 file can be NULL, even if the
    type has been set to a valid value. CVE-2024-0727 is a result of OpenSSL
    attempting to dereference the NULL pointer as a result of this.

    We add test for various instances of this problem.

    Reviewed-by: Tomas Mraz <tomas@openssl.org>
    Reviewed-by: Hugo Landau <hlandau@openssl.org>
    Reviewed-by: Neil Horman <nhorman@openssl.org>
    (Merged from https://github.com/openssl/openssl/pull/23362)

Signed-off-by: Dmitriy Popov <dpopov@cloudlinux.com>
---
 test/recipes/80-test_pkcs12.t             |  25 ++++++++++++++++++++--
 test/recipes/80-test_pkcs12_data/bad1.p12 | Bin 0 -> 85 bytes
 test/recipes/80-test_pkcs12_data/bad2.p12 | Bin 0 -> 104 bytes
 test/recipes/80-test_pkcs12_data/bad3.p12 | Bin 0 -> 104 bytes
 4 files changed, 23 insertions(+), 2 deletions(-)
 create mode 100644 test/recipes/80-test_pkcs12_data/bad1.p12
 create mode 100644 test/recipes/80-test_pkcs12_data/bad2.p12
 create mode 100644 test/recipes/80-test_pkcs12_data/bad3.p12

diff --git a/test/recipes/80-test_pkcs12.t b/test/recipes/80-test_pkcs12.t
index 430df67..e3dd9d2 100644
--- a/test/recipes/80-test_pkcs12.t
+++ b/test/recipes/80-test_pkcs12.t
@@ -9,7 +9,7 @@
 use strict;
 use warnings;
 
-use OpenSSL::Test qw/:DEFAULT srctop_file/;
+use OpenSSL::Test qw/:DEFAULT srctop_file with/;
 use OpenSSL::Test::Utils;
 
 use Encode;
@@ -57,7 +57,7 @@ if (eval { require Win32::API; 1; }) {
 }
 $ENV{OPENSSL_WIN32_UTF8}=1;
 
-plan tests => 1;
+plan tests => 5;
 
 # just see that we can read shibboleth.pfx protected with $pass
 ok(run(app(["openssl", "pkcs12", "-noout",
@@ -65,4 +65,25 @@ ok(run(app(["openssl", "pkcs12", "-noout",
             "-in", srctop_file("test", "shibboleth.pfx")])),
    "test_pkcs12");
 
+   # Test some bad pkcs12 files
+   my $bad1 = srctop_file("test", "recipes", "80-test_pkcs12_data", "bad1.p12");
+   my $bad2 = srctop_file("test", "recipes", "80-test_pkcs12_data", "bad2.p12");
+   my $bad3 = srctop_file("test", "recipes", "80-test_pkcs12_data", "bad3.p12");
+
+with({ exit_checker => sub { return shift == 1; } },
+      sub {
+         ok(run(app(["openssl", "pkcs12", "-in", $bad1, "-password", "pass:"])),
+            "test bad pkcs12 file 1");
+
+         ok(run(app(["openssl", "pkcs12", "-in", $bad1, "-password", "pass:",
+                     "-nomacver"])),
+            "test bad pkcs12 file 1 (nomacver)");
+
+         ok(run(app(["openssl", "pkcs12", "-in", $bad2, "-password", "pass:"])),
+            "test bad pkcs12 file 2");
+
+         ok(run(app(["openssl", "pkcs12", "-in", $bad3, "-password", "pass:"])),
+            "test bad pkcs12 file 3");
+      });
+
 SetConsoleOutputCP($savedcp) if (defined($savedcp));
diff --git a/test/recipes/80-test_pkcs12_data/bad1.p12 b/test/recipes/80-test_pkcs12_data/bad1.p12
new file mode 100644
index 0000000000000000000000000000000000000000..8f3387c7e356e4aa374729f3f3939343557b9c09
GIT binary patch
literal 85
zcmV-b0IL5mQvv}4Fbf6=Duzgg_YDCD0Wd)@F)$4V31Egu0c8UO0s#d81R(r{)waiY
rfR=Py6XX<mRyon58xHv)BAVy}k(l(hJwF5pk-=q7<yb@T0s;sC$etR(

literal 0
HcmV?d00001

diff --git a/test/recipes/80-test_pkcs12_data/bad2.p12 b/test/recipes/80-test_pkcs12_data/bad2.p12
new file mode 100644
index 0000000000000000000000000000000000000000..113cb6f1cd523e880db869f518e60142dc875115
GIT binary patch
literal 104
zcmXp=V`5}BkYnT2YV&CO&dbQoxImDF-+<SE8zIDI;AmiIz{|#&(B{FI%FM#V$jZQ?
z@Tpc|>#<$m7-wj)xrauuD`}hF=<J_T`^8$QMBK7d>Ng9=0`~S~)@=J%OiUaM0Oze6
AD*ylh

literal 0
HcmV?d00001

diff --git a/test/recipes/80-test_pkcs12_data/bad3.p12 b/test/recipes/80-test_pkcs12_data/bad3.p12
new file mode 100644
index 0000000000000000000000000000000000000000..ef86a1d86fb0bc09471ca2596d82e7d521d973a4
GIT binary patch
literal 104
zcmXp=V`5}BkYnT2YV&CO&dbQoxImDF-+<SE8%fB((ZJAvmyI)_&4V$OnT3gwm4QWp
zJ2GXlSm>oA$5$MVJL*60=F*5iN*C_e&wD%dwCM*q{=+OBX|Z+F7XSHN#>B+I003La
BAqM~e

literal 0
HcmV?d00001

-- 
2.34.1

